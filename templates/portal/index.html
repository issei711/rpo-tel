{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" >
  <link rel="stylesheet" href="{% static 'portal/css/index.css' %}">
{% endblock %}

{% block content_title %}
  <h1 class="portal-title">企業ポータル</h1>
{% endblock %}

{% block content %}
  {# ── 日付選択フォーム ── #}
  <form method="get" class="date-form">
    <label class="date-label">架電日を選択
      <input type="date" name="call_date" id="call_date_input" value="{{ selected_date }}" class="date-input">
    </label>
    <button type="button" class="date-btn today-btn" onclick="document.getElementById('call_date_input').value = new Date().toISOString().substr(0,10)">今日</button>
    <button type="button" class="date-btn clear-btn" onclick="document.getElementById('call_date_input').value = ''">クリア</button>
    <button type="submit" class="apply-btn">適用</button>
  </form>

  <div class="portal-container">
    {% for entry in companies_data %}
      <div class="portal-card">
        {# 左側：企業情報 #}
        <div class="portal-left">
          <h2 class="company-name">{{ entry.company.name }}</h2>
          <div class="company-actions">
            <a href="{% url 'company_student_redirect' entry.company.id %}?_facets=True" class="btn btn-entry">エントリー一覧</a>
            <a href="{% url 'student_upload_csv' entry.company.id %}" class="btn btn-upload">CSVアップロード</a>
          </div>
        </div>

        {# 右側：集計 #}
        <div class="portal-right">
          {# ― 日付結果グループ ― #}
          <div class="result-call-group">
            <div class="group-header">結果</div>
            <div class="group-cards">

              {# — 架電日合算件数 — #}
              <div class="call-card result-card">
                <div class="title">{{ entry.date }} の架電件数</div>
                <a href="{% url 'admin:students_student_changelist' %}?_facets=True&company={{ entry.company.id }}&call_date={{ entry.date }}">
                  <span class="count">{{ entry.count_on_date }}</span>
                </a>
              </div>

              {# — 処理必要件数 — #}
              <div class="call-card result-card">
                <div class="title">処理必要</div>
                <a href="{% url 'admin:students_student_changelist' %}?_facets=True&company={{ entry.company.id }}&need_process=1&done_draft=0&done_tel=0">
                  <span class="count">{{ entry.count_need_process }}</span>
                </a>
              </div>

              {# — Wチェック必要件数 — #}
              <div class="call-card result-card">
                <div class="title">Wチェック<br>必要</div>
                <a href="{% url 'admin:students_student_changelist' %}?_facets=True&company={{ entry.company.id }}&done_draft=1&done_tel=0">
                  <span class="count">{{ entry.count_wcheck }}</span>
                </a>
              </div>

            </div>
          </div>

          {# ― 未実施残りコール数カード ― #}
          <div class="call-group">
            <div class="group-header">対象</div>
            <div class="group-cards">
              <div class="call-card first">
                <div class="title">1コール目</div>
                <div class="icons">
                  <a href="{% url 'admin:students_student_changelist' %}?_facets=True&company={{ entry.company.id }}&call_progress=first">
                    <div class="icon-count">
                      <img src="{% static 'portal/img/first_call.png' %}" alt="1">
                      <span class="count">{{ entry.count1 }}</span>
                    </div>
                  </a>
                </div>
              </div>
              <div class="call-card">
                <div class="title">2コール目</div>
                <div class="icons">
                  <a href="{% url 'admin:students_student_changelist' %}?_facets=True&company={{ entry.company.id }}&detailed_call=2_morning">
                    <div class="icon-count">
                      <img src="{% static 'portal/img/morning.png' %}" alt="朝">
                      <span class="count">{{ entry.count2.morning }}</span>
                    </div>
                  </a>
                  <a href="{% url 'admin:students_student_changelist' %}?_facets=True&company={{ entry.company.id }}&detailed_call=2_noon">
                    <div class="icon-count">
                      <img src="{% static 'portal/img/noon.png' %}" alt="昼">
                      <span class="count">{{ entry.count2.noon }}</span>
                    </div>
                  </a>
                  <a href="{% url 'admin:students_student_changelist' %}?_facets=True&company={{ entry.company.id }}&detailed_call=2_evening">
                    <div class="icon-count">
                      <img src="{% static 'portal/img/evening.png' %}" alt="夕">
                      <span class="count">{{ entry.count2.evening }}</span>
                    </div>
                  </a>
                </div>
              </div>
              <div class="call-card">
                <div class="title">3コール目</div>
                <div class="icons">
                  <a href="{% url 'admin:students_student_changelist' %}?_facets=True&company={{ entry.company.id }}&detailed_call=3_morning">
                    <div class="icon-count">
                      <img src="{% static 'portal/img/morning.png' %}" alt="朝">
                      <span class="count">{{ entry.count3.morning }}</span>
                    </div>
                  </a>
                  <a href="{% url 'admin:students_student_changelist' %}?_facets=True&company={{ entry.company.id }}&detailed_call=3_noon">
                    <div class="icon-count">
                      <img src="{% static 'portal/img/noon.png' %}" alt="昼">
                      <span class="count">{{ entry.count3.noon }}</span>
                    </div>
                  </a>
                  <a href="{% url 'admin:students_student_changelist' %}?_facets=True&company={{ entry.company.id }}&detailed_call=3_evening">
                    <div class="icon-count">
                      <img src="{% static 'portal/img/evening.png' %}" alt="夕">
                      <span class="count">{{ entry.count3.evening }}</span>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <p>⚠️ 登録された企業がありません。</p>
    {% endfor %}
  </div>
{% endblock %}
